{"componentChunkName":"component---src-templates-blog-post-js","path":"/2021/07/writing-a-native-ionic-plugin-for-capacitor/","result":{"data":{"markdownRemark":{"html":"<p><strong>TLDR:</strong> <em>When the pandemic first started, I decided to develop a contact-tracing mobile app. I was studying Computer Science at the time and decided to use the same cross-platform framework that we were using on our course - Ionic. I wanted to use Google's <a href=\"https://developers.google.com/nearby/messages/overview\">Nearby Messages API</a> to share packets of information between iOS and Android devices via Bluetooth, but I couldn't find a plugin for this, so I decided to write my own!</em></p>\n<p><strong>View commits: <a href=\"https://github.com/JamesDHW/IonicNativePlugin/commit/614b47fe1e54fe43540d3f6b98f0899949673be4\">Android plugin</a> → <a href=\"https://github.com/JamesDHW/IonicNativePlugin/commit/9bcffc1b029ed0422c136fc367e544b4585f9115\">iOS plugin</a> → <a href=\"https://github.com/JamesDHW/IonicNativePlugin/commit/63510c8cc83b570fb639de6573a28bad58b87a3f\">Import native plugins</a>  → <a href=\"https://github.com/JamesDHW/IonicNativePlugin/commit/3652b264b287b5c909633e16532225e4293763cb\">Implementation</a></strong></p>\n<p><a href=\"https://ionicframework.com/\">Ionic</a> is a cross-platform mobile framework which allows you to develop an app using JavaScript/HTML/CSS and share this single implementation across different native devices. This Ionic project can then be compiled to native source code (Android/iOS) using Ionic's tool, <a href=\"https://capacitorjs.com/\">Capacitor</a>.</p>\n<p>Using a cross-platform framework like this to develop your mobile app is almost always a good idea, because it means you can maintain a single codebase which runs on both Android and iOS. This means you're not duplicating business logic across two different codebases in two different languages with two different teams (to be avoided).</p>\n<p>If you're looking to write some native code in a cross-platform project but you're still deciding which framework to use, check out this <a href=\"https://blog.theodo.com/2020/04/react-native-bridge-module/\">Theodo blog post</a> on React Native as well!</p>\n<h2>Step 1 - Search for existing solutions</h2>\n<p>Firstly, let's have a quick check that one of the <a href=\"https://capacitorjs.com/docs/apis\">default plugins</a> doesn't do the job for us already.</p>\n<p>Secondly, let's search through the <a href=\"https://github.com/capacitor-community\">community plugins</a> to find the feature we're looking for.</p>\n<p>No luck finding an existing plugin? Don't worry - let's move on to step 2!</p>\n<h2>Step 2 - Start a new app with Ionic + Capacitor</h2>\n<p>I'm starting a new project from scratch just to show you how it's done.</p>\n<pre><code>npm install -g @ionic/cli\n\nionic start &#x3C;app-name>\ncd &#x3C;app-name>\nionic serve &#x3C;-- you can serve your project on localhost\n</code></pre>\n<p>The <code>/src</code> directory of our Ionic project holds the source code for our cross-platform app.</p>\n<p>We can use Capacitor to compile this into two native projects:</p>\n<pre><code>npm install @capacitor/cli @capacitor/core\n\nnpx cap init\nnpx cap add ios\nnpx cap add android\n</code></pre>\n<p>When we make changes to our <code>/src</code> directory, we can apply those changes to our native projects by running <code>npx ionic build &#x26;&#x26; npx cap copy</code>.</p>\n<p>We now have our project set up and ready to add a custom plugin.</p>\n<h2>Step 3 - Check the documentation</h2>\n<p>Capacitor is well-documented and it's worth linking some references here to accompany this guide:</p>\n<p><a href=\"https://capacitorjs.com/docs/android/custom-code\">Getting started with Android</a></p>\n<p><a href=\"https://capacitorjs.com/docs/plugins/android\">Android reference</a></p>\n<p><a href=\"https://capacitorjs.com/docs/ios/custom-code\">Getting started with iOS</a></p>\n<p><a href=\"https://capacitorjs.com/docs/plugins/ios\">iOS reference</a></p>\n<h2>Step 4 - Define a strategy</h2>\n<p>There are three main steps to writing a plugin:</p>\n<ol>\n<li>(iOS &#x26; Android) Write a class in each native project to hold the native code we want to run (this is our plugin).</li>\n<li>(iOS &#x26; Android) Register these classes inside the bridge of our native projects to expose the methods.</li>\n<li>(Javascript - Ionic) Import and call the methods of our registered plugin.</li>\n</ol>\n<p>We should avoid duplicating code as much as much as possible (DRY), so all your business logic stays written in JavaScript, keeping the bare minimum written natively.</p>\n<p>Your plugins should be narrow in scope (do one specific thing) - make sure to follow this philosophy and give your plugin a specific name ('Plugin' is a bad name!).</p>\n<p>We have two main strategies for calling our plugins:</p>\n<ul>\n<li>An (asynchronous) method: we call some native method which we can <code>await</code> in our business logic in Ionic.</li>\n<li>Event listeners: define a listener in our business logic. Events can be triggered in our native code to pass payloads back to the business logic.</li>\n</ul>\n<p>If we are subscribing to a stream of events (expecting our method to resolve with multiple payloads over a longer time period e.g. geolocation/ Bluetooth updates), then event listeners are the appropriate way to handle our native calls.</p>\n<h2>Step 5 - Write and register the Android plugin</h2>\n<p>[<a href=\"https://github.com/JamesDHW/IonicNativePlugin/commit/614b47fe1e54fe43540d3f6b98f0899949673be4\">View the commit</a>]</p>\n<p>Open the <code>/android</code> directory of your project in Android Studio.</p>\n<p>In <code>/app/src/main/java/../../..</code> (next to <code>MainActivity.java</code>), we can create a new file (I'm calling mine <code>IonicNativePluginExample.java</code>) and write a class which extends the Capacitor <code>Plugin</code> class:</p>\n<pre><code class=\"language-java\">package /* &#x3C;package-name> */; // e.g. io.ionic.starter\n\nimport com.getcapacitor.JSObject;\nimport com.getcapacitor.Plugin;\nimport com.getcapacitor.PluginCall;\nimport com.getcapacitor.PluginMethod;\nimport com.getcapacitor.annotation.CapacitorPlugin;\n\n@CapacitorPlugin(name = \"IonicNativePluginExample\")\npublic class IonicNativePluginExample extends Plugin {\n\n    @PluginMethod\n    public void NativeMethod(PluginCall call){\n        JSObject result = new JSObject();\n        result.put(\"message\", \"Hello Android user!\");\n        call.resolve(result);\n    }\n\n    @PluginMethod\n    public void NotifyListeners(PluginCall call){\n        JSObject result = new JSObject();\n        result.put(\"message\", \"Hello Android user!\");\n        notifyListeners(\"EVENT_LISTENER_NAME\", result);\n    }\n\n}\n</code></pre>\n<p>Next, we can register this plugin in <code>MainActivity.java</code> where Capacitor initialises its bridge:</p>\n<pre><code class=\"language-java\">package /* &#x3C;package-name> */; // e.g. io.ionic.starter\n\nimport android.os.Bundle;\nimport com.getcapacitor.BridgeActivity;\n\npublic class MainActivity extends BridgeActivity {\n    @Override\n    public void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        registerPlugin(IonicNativePluginExample.class);\n\n    }\n}\n</code></pre>\n<p>We can run our project like any other native Android project, by pressing the 'play' button in Android Studio.</p>\n<p>If you're looking to develop in Kotlin - Android Studio comes with tooling to convert this Java class to Kotlin (right-click the file you want to convert).</p>\n<p><strong>Note: you might need to edit the Gradle <code>distributionUrl</code> to get the project build to succeed - there's an example in my repo <a href=\"https://github.com/JamesDHW/IonicNativePlugin/commit/e7abb66621ca0c0444cee55aa7f3d40a621eeef7\">here</a>.</strong></p>\n<h2>Step 6 - Write and register the iOS plugin</h2>\n<p>[<a href=\"https://github.com/JamesDHW/IonicNativePlugin/commit/9bcffc1b029ed0422c136fc367e544b4585f9115\">View the commit</a>]</p>\n<p>Open the <code>ios/App</code> directory of your project in Xcode.</p>\n<p>In <code>/App</code> (next to <code>AppDelegate.swift</code>), we can right-click on the directory to create a new swift file (I'm calling mine <code>IonicNativePluginExample.swift</code>). This will hold our plugin class with our <code>IonicNativePluginExample</code> method.</p>\n<pre><code class=\"language-swift\">import Foundation\nimport Capacitor\n\n@objc(IonicNativePluginExample)\npublic class IonicNativePluginExample: CAPPlugin {\n\n\t@objc func NativeMethod(_ call: CAPPluginCall) {\n\t\tcall.resolve([\"message\": \"Hello iOS user!\"])\n\t}\n\n\t@objc func NotifyListeners(_ call: CAPPluginCall) {\n\t\tself.notifyListeners(\n\t\t\t\"EVENT_LISTENER_NAME\",\n\t\t\tdata: [\"message\": \"Hello iOS user!\"]\n\t\t)\n\t}\n\n}\n</code></pre>\n<p>Next, we must register our plugin in a new Objective-C file called <code>IonicNativePluginExample.m</code> (same name as our plugin file but with a <code>.m</code> extension). When prompted by Xcode, create a Bridging Header file (which is an empty file called <code>App-Bridging-Header.h</code>), then register the plugin like so:</p>\n<pre><code class=\"language-objectivec\">#import &#x3C;Foundation/Foundation.h>\n#import &#x3C;Capacitor/Capacitor.h>\n\nCAP_PLUGIN(IonicNativePluginExample, \"IonicNativePluginExample\",\n           CAP_PLUGIN_METHOD(NativeMethod, CAPPluginReturnPromise);\n           CAP_PLUGIN_METHOD(NotifyListeners, CAPPluginReturnPromise);\n)\n</code></pre>\n<p>We can run our project like any other native iOS project, by pressing the 'play' button in Xcode.</p>\n<h2>Step 7 - Import and call our plugin in Ionic</h2>\n<p>[<a href=\"https://github.com/JamesDHW/IonicNativePlugin/commit/63510c8cc83b570fb639de6573a28bad58b87a3f\">View the commit</a>]</p>\n<p>Finally, we can now access the plugins we have written from our Ionic project. I've created a <code>/plugins</code> directory to export mine from. We import <code>registerPlugin</code> from Capacitor to find the plugin we have registered in Android and iOS:</p>\n<pre><code class=\"language-jsx\">import { registerPlugin, Plugin } from \"@capacitor/core\";\n\n// we can take advantage of TypeScript here!\ninterface NativePluginInterface extends Plugin {\n  NativeMethod: () => Promise&#x3C;Record&#x3C;\"message\", string>>;\n  NotifyListeners: () => Promise&#x3C;void>;\n};\n\n// it's important that both Android and iOS plugins have the same name\nexport const IonicNativePluginExample = registerPlugin&#x3C;NativePluginInterface>(\n  \"IonicNativePluginExample\"\n);\n</code></pre>\n<p>Now we can call the methods in our plugin and access the native code:</p>\n<pre><code class=\"language-jsx\">import { IonicNativePluginExample } from './plugins/IonicNativePluginExample'\n\n...\n\n// add a listener to native events which invokes some callback\nIonicNativePluginExample.addListener(\"EVENT_LISTENER_NAME\", ({ message }) =>\n    console.log(message);\n);\n\n// destructure the methods to call our native code from our non-native app\nconst { NativeMethod, NotifyListeners } = IonicNativePluginExample;\n\n// native methods are asynchronous\nconst { message } = await NativeMethod();\n\n// this method will trigger our event listener\nNotifyListeners();\n</code></pre>\n<p><strong>Note: to see our changes reflected when we run the project natively, we need to run <code>npx ionic build &#x26;&#x26; npx cap copy</code>.</strong></p>\n<p>We now have a cross-platform app set up ready to write a native implementation. We run the same business logic from our Ionic app and get a different implementation for each device we run on.</p>\n<p>I made a small edit to our Ionic project to create the simple implementation below - you can view the commit <a href=\"https://github.com/JamesDHW/IonicNativePlugin/commit/3652b264b287b5c909633e16532225e4293763cb\">here</a>.</p>\n<p><img src=\"demo-app.png\" alt=\"demo-app.png\"></p>\n<h2>More complex plugins</h2>\n<p>With the above setup, you should be ready to write more complex native code to suit your needs for a cross-platform Ionic application.</p>\n<p>I wrote a native Plugin for Google's Nearby Messages API, which is a publish-subscribe API made by Google which facilitates the transfer of information between internet-connected Android and iOS devices.</p>\n<p>Nearby Messages uses a combination of Bluetooth, Bluetooth Low Energy, Wi-Fi, and near-ultrasonic communication between nearby devices to create a unique pairing. This pairing is then used to send small payloads over the internet between nearby devices.</p>\n<p>Here's a quick code snippet from the Android plugin:</p>\n<pre><code class=\"language-java\">...\n\nimport com.google.android.gms.nearby.Nearby;\nimport com.google.android.gms.nearby.messages.Message;\nimport com.google.android.gms.nearby.messages.MessageListener;\n\n...\n\n@NativePlugin()\npublic class NearbyMessagesPlugin extends Plugin {\n\n\t\tprivate Message mMessage;\n    private MessageListener mMessageListener = new MessageListener() {\n        @Override\n        public void onFound(Message message) {\n            JSObject result = new JSObject();\n            result.put(\"message\", new String (message.getContent()));\n            notifyListeners(\"FOUND_MESSAGE\", result);\n        }\n\n        @Override\n        public void onLost(Message message) {\n            JSObject result = new JSObject();\n            result.put(\"message\",  new String (message.getContent()));\n            notifyListeners(\"LOST_MESSAGE\", result);\n        }\n    };\n\n    @PluginMethod\n    public void Subscribe(PluginCall call){\n        Nearby.getMessagesClient(getContext()).subscribe(mMessageListener);\n    }\n\n    @PluginMethod\n    public void Publish(PluginCall call){\n        String value = call.getString(\"message\", \"-\");\n        mMessage = new Message(value.getBytes());\n        Nearby.getMessagesClient(getContext()).publish(mMessage);\n    }\n}\n</code></pre>\n<p>Event listeners are appropriate here because although we don't know when/if the phone will pick up a Bluetooth signal, a side-effect can still be triggered in the business logic when it does. <code>Subscribe</code> can be invoked to subscribe to <code>mMessageListener</code> and listen for Bluetooth messages (or we could just call <code>Subscribe</code> in the <code>onCreate</code> of our native code if we wanted to).</p>\n<h2>Summary</h2>\n<p>Once you've got a simple implementation, you can move on and write some more complex native code.</p>\n<p>If you want a quick-start, you can fork my <a href=\"https://github.com/JamesDHW/IonicNativePlugin\">repository on GitHub</a>, but following along with the article and doing it yourself will really help your understanding.</p>","frontmatter":{"date":"July 12, 2021","slug":"writing-a-native-ionic-plugin-for-capacitor","title":"Writing a native Ionic plugin for Capacitor in less than 30 minutes"}}},"pageContext":{"authors":["James Haworth Wheatman"],"slug":"/2021/07/writing-a-native-ionic-plugin-for-capacitor/"}},"staticQueryHashes":[]}